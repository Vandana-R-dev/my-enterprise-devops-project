pipeline {
  agent any

  environment {
    REGISTRY = "quay.io/rakeshreddy1990/demo-app"
    IMAGE_TAG = "${BUILD_NUMBER}"
  }

  stages {

    stage('Build Image') {
      steps {
        sh 'docker build -t $REGISTRY:$IMAGE_TAG app/'
      }
    }

    stage('Push Image to Quay') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'quay-creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
          sh '''
          docker login -u $USER -p $PASS quay.io
          docker push $REGISTRY:$IMAGE_TAG
          '''
        }
      }
    }

    stage('Deploy to Dev') {
      steps {
        withCredentials([string(credentialsId: 'oc-token-dev', variable: 'TOKEN')]) {
          sh '''
          oc login https://api.crc.testing:6443 --token=$TOKEN --insecure-skip-tls-verify
          oc project dev
          helm upgrade --install app-dev helm -f helm/values-dev.yaml --set image.tag=$IMAGE_TAG -n dev
          '''
        }
      }
    }

    stage('Promote to SIT') {
      steps {
        input message: "Deploy build ${BUILD_NUMBER} to SIT?"
        withCredentials([string(credentialsId: 'oc-token-sit', variable: 'TOKEN')]) {
          sh '''
          oc login https://api.crc.testing:6443 --token=$TOKEN --insecure-skip-tls-verify
          oc project sit
          helm upgrade --install app-sit helm -f helm/values-sit.yaml --set image.tag=$IMAGE_TAG -n sit
          '''
        }
      }
    }
  }
}

