pipeline {
    agent none
    environment {
        REGISTRY = "quay.io/rakeshreddy1990/demo-app"
        IMAGE_TAG = "${BUILD_NUMBER}"
    }
    stages {
        stage('Build & Push') {
            agent {
                docker {
                    image 'docker:27.3-dind'
                    args '--privileged --user root'
                }
            }
            steps {
                withCredentials([usernamePassword(credentialsId: 'quay-creds', 
                                    usernameVariable: 'USER', 
                                    passwordVariable: 'PASS')]) {
                    sh '''
                    dockerd-entrypoint.sh &
                    sleep 10
                    docker build -t $REGISTRY:$IMAGE_TAG ./app/
                    docker tag $REGISTRY:$IMAGE_TAG $REGISTRY:latest
                    echo $PASS | docker login -u $USER --password-stdin quay.io
                    docker push $REGISTRY:$IMAGE_TAG
                    docker push $REGISTRY:latest
                    '''
                }
            }
        }
        
        stage('Deploy Dev') {
            agent any
            steps {
                withCredentials([string(credentialsId: 'oc-token-dev', variable: 'TOKEN')]) {
                    sh '''
                    oc login https://api.crc.testing:6443 --token=$TOKEN --insecure-skip-tls-verify=true
                    oc project dev
                    helm upgrade --install app-dev ./helm -f helm/values-dev.yaml --set image.tag=$IMAGE_TAG -n dev
                    '''
                }
            }
        }
        
        stage('Promote to SIT') {
            agent any
            steps {
                input message: "Deploy build ${BUILD_NUMBER} to SIT?"
                withCredentials([string(credentialsId: 'oc-token-sit', variable: 'TOKEN')]) {
                    sh '''
                    oc login https://api.crc.testing:6443 --token=$TOKEN --insecure-skip-tls-verify=true
                    oc project sit
                    helm upgrade --install app-sit ./helm -f helm/values-sit.yaml --set image.tag=$IMAGE_TAG -n sit
                    '''
                }
            }
        }
    }
}
