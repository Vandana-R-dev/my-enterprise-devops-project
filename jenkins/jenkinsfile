pipeline {
    agent any
    
    environment {
        REGISTRY = "quay.io/rakeshreddy1990/demo-app"
        IMAGE_TAG = "${BUILD_NUMBER}"
        DOCKER_IMAGE = "${REGISTRY}:${IMAGE_TAG}"
        DOCKER_LATEST = "${REGISTRY}:latest"
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'ls -la helm/ app/'
            }
        }
        
        stage('Build Image') {
            steps {
                sh '''
                docker build -t ${DOCKER_IMAGE} ./app/
                docker tag ${DOCKER_IMAGE} ${DOCKER_LATEST}
                '''
            }
        }
        
        stage('Push to Quay') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'quay-creds', 
                                    usernameVariable: 'QUAY_USER', 
                                    passwordVariable: 'QUAY_PASS')]) {
                    sh '''
                    echo $QUAY_PASS | docker login -u $QUAY_USER --password-stdin quay.io
                    docker push ${DOCKER_IMAGE}
                    docker push ${DOCKER_LATEST}
                    '''
                }
            }
        }
        
        stage('Deploy to Dev') {
            steps {
                withCredentials([string(credentialsId: 'oc-token-dev', variable: 'OC_TOKEN')]) {
                    sh '''
                    oc login https://api.crc.testing:6443 --token=${OC_TOKEN} --insecure-skip-tls-verify=true
                    oc project dev
                    helm upgrade --install app-dev ./helm/ \\
                      --set image.repository=quay.io/rakeshreddy1990/demo-app \\
                      --set image.tag=${IMAGE_TAG} \\
                      --namespace dev
                    '''
                }
            }
        }
        
        stage('Test Dev') {
            steps {
                sh '''
                oc rollout status deployment/app-dev -n dev --timeout=300s
                curl -f http://app-dev.dev.svc.cluster.local:8080/health || true
                '''
            }
        }
        
        stage('Promote to SIT - APPROVAL REQUIRED') {
            steps {
                input message: "Approve deployment of build #${BUILD_NUMBER} to SIT?", 
                      ok: "Deploy to SIT",
                      submitter: "devops-team"
            }
            steps {
                withCredentials([string(credentialsId: 'oc-token-sit', variable: 'OC_TOKEN')]) {
                    sh '''
                    oc login https://api.crc.testing:6443 --token=${OC_TOKEN} --insecure-skip-tls-verify=true
                    oc project sit
                    helm upgrade --install app-sit ./helm/ \\
                      --set image.repository=quay.io/rakeshreddy1990/demo-app \\
                      --set image.tag=${IMAGE_TAG} \\
                      --namespace sit
                    '''
                }
            }
        }
        
        stage('Validate SIT') {
            steps {
                sh '''
                oc rollout status deployment/app-sit -n sit --timeout=300s
                sleep 30
                curl -f http://app-sit.sit.svc.cluster.local:8080/health || true
                '''
            }
        }
    }
    
    post {
        always {
            sh '''
            echo "Pipeline completed - Build #${BUILD_NUMBER}"
            oc get pods -n dev,sit
            '''
        }
        success {
            echo "üéâ PIPELINE SUCCESSFUL - ${DOCKER_IMAGE} deployed to SIT!"
        }
        failure {
            echo "‚ùå Pipeline failed - Check logs above"
            emailext (
                subject: "Build FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: "Check console output at ${env.BUILD_URL}",
                to: "team@company.com"
            )
        }
    }
}
